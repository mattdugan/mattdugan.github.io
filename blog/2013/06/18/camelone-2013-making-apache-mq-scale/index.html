
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>CamelOne 2013: Making Apache MQ Scale - Matt Dugan</title>
  <meta name="author" content="Matt Dugan">

  
  <meta name="description" content="Hiram Chirino is one of the authors of
Apache MQ, so this should be good. Apache MQ is designed for Machine to Machine, push-style messaging and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mattdugan.github.io/blog/2013/06/18/camelone-2013-making-apache-mq-scale">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Matt Dugan" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Matt Dugan</a></h1>
  
    <h2>Just a blog.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://duckduckgo.com" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mattdugan.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">CamelOne 2013: Making Apache MQ Scale</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-18T08:43:00-04:00" pubdate data-updated="true">Jun 18<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://hiramchirino.com/blog">Hiram Chirino</a> is one of the authors of
Apache MQ, so this should be good.</p>

<p>Apache MQ is designed for Machine to Machine, push-style messaging and
enables vertical scaling through high performance as well as
horizontal scaling through clustering and partitioning.  Hiram gave
a number of scaling tips for Apache MQ, which should mostly apply to
<a href="https://www.redhat.com/products/jbossenterprisemiddleware/fuse/">JBoss Fuse</a>
since Apache MQ is embedded.</p>

<h2>Vertical Scaling</h2>

<p>To start, vertical scaling, or allowing a single Apache MQ broker to
serve more traffic than before, can be improved with a few parameters:</p>

<ul>
<li>Set the configuration for using a dedicated task runner to false.</li>
<li>Set the destination policy setting for optimizing dispatch to true.</li>
<li>Use the NIO transport on the broker</li>
<li>Reduce the thread size on the JVM via the Xss option</li>
</ul>


<p>If using version 5.6 of Apache MQ, then non-blocking callbacks for
ACK-ing receipt of JMS messages are available which can improve
performance by incurring fewer thread waits.</p>

<p>If using version 5.8, a new backing store is available, called
<a href="https://github.com/fusesource/fuse-extra/tree/master/fusemq-leveldb">Level DB</a>
instead of <a href="https://activemq.apache.org/kahadb.html">Kaha DB</a> which
offers higher performance in nearly all cases.</p>

<h2>Horizontal Scaling</h2>

<p>Scaling <em>out</em> is usally a little more tricky than scaling <em>up</em>.  In
Apache MQ, there are two primary methods for scaling out
horizontally in your messaging architecture:</p>

<ol>
<li>Use client side partitioning by having multiple brokers, each
for a set of clients.</li>
<li>Link brokers together in a cluster configuration.</li>
</ol>


<p>The second method is the out of box &ldquo;easy button&rdquo;, but it is
important to note that it does NOT make Apache MQ <em>faster</em>.  Instead,
in some cases it is <em>slower</em> because it may add a network hop
between brokers to reach a particular connected client path.</p>

<p>The first method is more difficult to configure and maintain as
clients scale out, so it is best used where the messaging topology
matches with the broker partitioning scheme. This occurs when clients
are naturally separated by geography or business purpose and
producers <em>know</em> which client group should receive a particular
message and can select the broker accordingly.</p>

<h2>High Availability</h2>

<p>Even with Horizontal Scaling practices, it is still possible to lose a
broker and, particularly when using partioning, the associated set of
clients.  This is where a High Availability configuration comes into
play &ndash; to allow clients to continue receiving messages when their
primary broker fails.</p>

<p>HA configurations often use a failover URI type, written as
<code>failover://(address1,address2,...)</code> but high availability can also
be acheived by clustering at the database level (which is still a
single point of failure, only now at the DB instead of the message
broker).  Alternately shared filesystems can be used and, in the case
of Apache MQ 5.9, a replicated Level DB using Zookeeper for automatic
leader election.</p>

<p>The <a href="https://zookeeper.apache.org/">Zookeeper</a> case is an interesting
one, as it is also the officially supported tool embedded within
<a href="http://fusesource.com/products/fuse-fabric/">Fuse Fabric</a> as the
service registry.  When a fabric URI is used, the client can dynamically
discover and resolve slave instances of brokers from the directory.</p>

<p>It is important to consider the system load when using Zookeeper, as
Zookeeper does not respond well in cases of CPU contention and this
can impact leader election.  Keeping Zookeeper hosted separately from
the Apache MQ broker helps with this, and you need at least 3 Zookeeper
instances to achieve High Availability through Zookeeper, and at least
5 to have high reliability.</p>

<h2>Demo Time</h2>

<p>Hiram made use of <a href="http://tmux.sourceforge.net/">Tmux</a> to automatically
echo his commands across multiple terminals, live in front of the
audience.  This speeds up the demo quite a bit, looks awesome, and
lends credibility to him as a presenter for using a cool tool.</p>

<p>The demo went well, showing brokers going down and the clients
recovering without losing messages.</p>

<h2>Closing Thoughts</h2>

<p>A lot of features are new in the 5.9 version of Apache MQ, but won&rsquo;t
make it into RedHat JBoss Fuse until early next year.<br/>
RedHat JBoss Fuse sees Apache MQ as upstream code and takes some time
to certify it for enterprise level support.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Matt Dugan</span></span>

      








  


<time datetime="2013-06-18T08:43:00-04:00" pubdate data-updated="true">Jun 18<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/apachemq/'>ApacheMQ</a>, <a class='category' href='/blog/categories/camel/'>Camel</a>, <a class='category' href='/blog/categories/camelone/'>CamelOne</a>, <a class='category' href='/blog/categories/fuse/'>Fuse</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/06/17/camelone-2013-drools-with-apache-camel-dot-rules/" title="Previous Post: CamelOne 2013: Drools with Apache Camel.. Rules">&laquo; CamelOne 2013: Drools with Apache Camel.. Rules</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/06/25/judcon-2013-full-control-and-transparency/" title="Next Post: JUDCon 2013: Full Control &amp; Transparency">JUDCon 2013: Full Control &amp; Transparency &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/07/11/red-hat-summit-2013-cloud-bursting-with-openshift/">Red Hat Summit 2013: Cloud Bursting With OpenShift</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/11/red-hat-summit-2013-the-jboss-way/">Red Hat Summit 2013: The JBoss Way</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/11/judcon-2013-resilient-enterprise-messaging-with-fuse-and-red-hat-enterprise-linux/">JUDCon 2013: Resilient Enterprise Messaging With Fuse &amp; Red Hat Enterprise Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/25/judcon-2013-so-you-want-to-be-a-jboss-rock-star/">JUDCon 2013: So You Want to Be a JBoss Rock Star</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/25/judcon-2013-building-html5-applications/">JUDCon 2013: Building HTML5 Applications</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/25/judcon-2013-full-control-and-transparency/">JUDCon 2013: Full Control &amp; Transparency</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/18/camelone-2013-making-apache-mq-scale/">CamelOne 2013: Making Apache MQ Scale</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/17/camelone-2013-drools-with-apache-camel-dot-rules/">CamelOne 2013: Drools With Apache Camel.. Rules</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/17/rich-web-applications-with-jboss-errai/">JUDCon 2013: Rich Web Applications With JBoss Errai</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/17/judcon-2013-jboss-grid-and-websockets/">JUDCon 2013: JBoss Data Grid and WebSockets</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/17/camelone-2013-camel-cookbook/">CamelOne 2013: Camel Cookbook</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/11/new-job-slash/">New Job</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mattdugan">@mattdugan</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mattdugan',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/Matt D?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Matt Dugan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>







</body>
</html>
